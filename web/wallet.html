<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Connect - Disaster Response</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }
        
        .card h2 {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .status.connected {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
        }
        
        .status.disconnected {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
        }
        
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .dot.green { background: var(--success); }
        .dot.red { background: var(--danger); }
        
        .address {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.95rem;
            background: var(--bg-dark);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            word-break: break-all;
            margin: 1rem 0;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.875rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-dark);
            color: var(--text);
            font-size: 1rem;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .result {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.85rem;
            word-break: break-all;
            white-space: pre-wrap;
        }
        
        .result.success {
            border-left: 3px solid var(--success);
        }
        
        .result.error {
            border-left: 3px solid var(--danger);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .info-item {
            background: var(--bg-dark);
            padding: 1rem;
            border-radius: 8px;
        }
        
        .info-item .label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }
        
        .info-item .value {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .hidden { display: none !important; }
        
        .metamask-icon {
            width: 24px;
            height: 24px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîê Wallet Connect</h1>
            <p class="subtitle">Disaster Response Network - Blockchain Integration</p>
        </header>
        
        <!-- Connection Status -->
        <div class="card">
            <h2>üì° Connection Status</h2>
            
            <div id="status-disconnected" class="status disconnected">
                <span class="dot red"></span>
                <span>Not Connected</span>
            </div>
            
            <div id="status-connected" class="status connected hidden">
                <span class="dot green"></span>
                <span>Connected to <span id="network-name">Unknown Network</span></span>
            </div>
            
            <div id="wallet-address" class="address hidden"></div>
            
            <div class="btn-group">
                <button id="btn-connect" class="btn btn-primary">
                    <svg class="metamask-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.5 11H19V7c0-1.1-.9-2-2-2h-4V3.5a2.5 2.5 0 00-5 0V5H4c-1.1 0-2 .9-2 2v4H.5a.5.5 0 000 1H2v4c0 1.1.9 2 2 2h4v1.5a2.5 2.5 0 005 0V18h4c1.1 0 2-.9 2-2v-4h1.5a.5.5 0 000-1zM9 3.5A1.5 1.5 0 0110.5 2a1.5 1.5 0 011.5 1.5V5h-3V3.5zM15 18h-4v1.5a1.5 1.5 0 01-1.5 1.5A1.5 1.5 0 018 19.5V18H4c-.55 0-1-.45-1-1v-4h1.5a.5.5 0 000-1H3V8c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v4h-1.5a.5.5 0 000 1H19v4c0 .55-.45 1-1 1h-3z"/>
                    </svg>
                    Connect MetaMask
                </button>
                <button id="btn-disconnect" class="btn btn-danger hidden">
                    Disconnect
                </button>
            </div>
        </div>
        
        <!-- Wallet Info (shown when connected) -->
        <div id="wallet-info" class="card hidden">
            <h2>üí∞ Wallet Information</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="label">Balance</div>
                    <div class="value" id="balance">0.00 ETH</div>
                </div>
                <div class="info-item">
                    <div class="label">Network</div>
                    <div class="value" id="chain-id">-</div>
                </div>
                <div class="info-item">
                    <div class="label">Block Number</div>
                    <div class="value" id="block-number">-</div>
                </div>
            </div>
        </div>
        
        <!-- Sign Message (shown when connected) -->
        <div id="sign-section" class="card hidden">
            <h2>‚úçÔ∏è Sign Message</h2>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">
                Sign a message to prove ownership of your wallet.
            </p>
            
            <div class="form-group">
                <label for="message-input">Message to Sign</label>
                <textarea id="message-input" placeholder="Enter your message here...">I am verifying my identity for the Disaster Response Network.\n\nTimestamp: ${new Date().toISOString()}</textarea>
            </div>
            
            <button id="btn-sign" class="btn btn-success">
                ‚úçÔ∏è Sign Message
            </button>
            
            <div id="sign-result" class="result hidden"></div>
        </div>
        
        <!-- Verify Signature -->
        <div class="card">
            <h2>üîç Verify Signature</h2>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">
                Verify that a message was signed by a specific address.
            </p>
            
            <div class="form-group">
                <label for="verify-message">Original Message</label>
                <textarea id="verify-message" placeholder="Enter the original message..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="verify-signature">Signature</label>
                <input type="text" id="verify-signature" placeholder="0x...">
            </div>
            
            <div class="form-group">
                <label for="verify-address">Expected Signer Address</label>
                <input type="text" id="verify-address" placeholder="0x...">
            </div>
            
            <button id="btn-verify" class="btn btn-primary">
                üîç Verify
            </button>
            
            <div id="verify-result" class="result hidden"></div>
        </div>
        
        <!-- Backend Wallet API -->
        <div class="card">
            <h2>üñ•Ô∏è Backend Wallet API</h2>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">
                Use these endpoints for server-side wallet operations.
            </p>
            
            <div class="info-grid">
                <div class="info-item">
                    <div class="label">Create Wallet</div>
                    <div class="value" style="font-size: 0.9rem;">POST /api/wallet/create</div>
                </div>
                <div class="info-item">
                    <div class="label">Import Mnemonic</div>
                    <div class="value" style="font-size: 0.9rem;">POST /api/wallet/import/mnemonic</div>
                </div>
                <div class="info-item">
                    <div class="label">Sign Message</div>
                    <div class="value" style="font-size: 0.9rem;">POST /api/wallet/sign-message</div>
                </div>
                <div class="info-item">
                    <div class="label">Get Balance</div>
                    <div class="value" style="font-size: 0.9rem;">GET /api/wallet/balance/{address}</div>
                </div>
            </div>
            
            <div style="margin-top: 1rem;">
                <a href="/docs#/Wallet" class="btn btn-primary" target="_blank">
                    üìö View API Documentation
                </a>
            </div>
        </div>
    </div>
    
    <script>
        // State
        let provider = null;
        let signer = null;
        let connectedAddress = null;
        
        // Elements
        const btnConnect = document.getElementById('btn-connect');
        const btnDisconnect = document.getElementById('btn-disconnect');
        const btnSign = document.getElementById('btn-sign');
        const btnVerify = document.getElementById('btn-verify');
        const statusDisconnected = document.getElementById('status-disconnected');
        const statusConnected = document.getElementById('status-connected');
        const walletAddress = document.getElementById('wallet-address');
        const walletInfo = document.getElementById('wallet-info');
        const signSection = document.getElementById('sign-section');
        const networkName = document.getElementById('network-name');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkConnection();
        });
        
        // Check if already connected
        async function checkConnection() {
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    await connectWallet();
                }
            }
        }
        
        // Connect Wallet
        btnConnect.addEventListener('click', connectWallet);
        
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('MetaMask is not installed! Please install MetaMask extension.');
                return;
            }
            
            try {
                btnConnect.disabled = true;
                btnConnect.innerHTML = '<span class="loading">Connecting...</span>';
                
                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Create provider and signer
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                connectedAddress = await signer.getAddress();
                
                // Update UI
                updateConnectedUI();
                
                // Listen for account/network changes
                window.ethereum.on('accountsChanged', handleAccountChange);
                window.ethereum.on('chainChanged', () => window.location.reload());
                
            } catch (error) {
                console.error('Connection error:', error);
                alert('Failed to connect: ' + error.message);
            } finally {
                btnConnect.disabled = false;
                btnConnect.innerHTML = `
                    <svg class="metamask-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.5 11H19V7c0-1.1-.9-2-2-2h-4V3.5a2.5 2.5 0 00-5 0V5H4c-1.1 0-2 .9-2 2v4H.5a.5.5 0 000 1H2v4c0 1.1.9 2 2 2h4v1.5a2.5 2.5 0 005 0V18h4c1.1 0 2-.9 2-2v-4h1.5a.5.5 0 000-1zM9 3.5A1.5 1.5 0 0110.5 2a1.5 1.5 0 011.5 1.5V5h-3V3.5zM15 18h-4v1.5a1.5 1.5 0 01-1.5 1.5A1.5 1.5 0 018 19.5V18H4c-.55 0-1-.45-1-1v-4h1.5a.5.5 0 000-1H3V8c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v4h-1.5a.5.5 0 000 1H19v4c0 .55-.45 1-1 1h-3z"/>
                    </svg>
                    Connect MetaMask
                `;
            }
        }
        
        // Update UI when connected
        async function updateConnectedUI() {
            statusDisconnected.classList.add('hidden');
            statusConnected.classList.remove('hidden');
            walletAddress.classList.remove('hidden');
            walletInfo.classList.remove('hidden');
            signSection.classList.remove('hidden');
            btnConnect.classList.add('hidden');
            btnDisconnect.classList.remove('hidden');
            
            walletAddress.textContent = connectedAddress;
            
            // Get network info
            const network = await provider.getNetwork();
            networkName.textContent = network.name || `Chain ${network.chainId}`;
            document.getElementById('chain-id').textContent = network.chainId.toString();
            
            // Get balance
            const balance = await provider.getBalance(connectedAddress);
            document.getElementById('balance').textContent = 
                parseFloat(ethers.formatEther(balance)).toFixed(4) + ' ETH';
            
            // Get block number
            const blockNumber = await provider.getBlockNumber();
            document.getElementById('block-number').textContent = blockNumber.toLocaleString();
        }
        
        // Handle account change
        function handleAccountChange(accounts) {
            if (accounts.length === 0) {
                disconnectWallet();
            } else {
                connectedAddress = accounts[0];
                updateConnectedUI();
            }
        }
        
        // Disconnect
        btnDisconnect.addEventListener('click', disconnectWallet);
        
        function disconnectWallet() {
            provider = null;
            signer = null;
            connectedAddress = null;
            
            statusDisconnected.classList.remove('hidden');
            statusConnected.classList.add('hidden');
            walletAddress.classList.add('hidden');
            walletInfo.classList.add('hidden');
            signSection.classList.add('hidden');
            btnConnect.classList.remove('hidden');
            btnDisconnect.classList.add('hidden');
            
            document.getElementById('sign-result').classList.add('hidden');
        }
        
        // Sign Message
        btnSign.addEventListener('click', async () => {
            const message = document.getElementById('message-input').value;
            const resultDiv = document.getElementById('sign-result');
            
            if (!message) {
                resultDiv.textContent = 'Please enter a message to sign';
                resultDiv.className = 'result error';
                resultDiv.classList.remove('hidden');
                return;
            }
            
            try {
                btnSign.disabled = true;
                btnSign.textContent = 'Signing...';
                
                const signature = await signer.signMessage(message);
                
                resultDiv.innerHTML = `<strong>‚úÖ Signature Created!</strong>\n\n` +
                    `<strong>Message:</strong>\n${message}\n\n` +
                    `<strong>Signature:</strong>\n${signature}\n\n` +
                    `<strong>Signer:</strong>\n${connectedAddress}`;
                resultDiv.className = 'result success';
                resultDiv.classList.remove('hidden');
                
                // Auto-fill verify section
                document.getElementById('verify-message').value = message;
                document.getElementById('verify-signature').value = signature;
                document.getElementById('verify-address').value = connectedAddress;
                
            } catch (error) {
                resultDiv.textContent = 'Error: ' + error.message;
                resultDiv.className = 'result error';
                resultDiv.classList.remove('hidden');
            } finally {
                btnSign.disabled = false;
                btnSign.textContent = '‚úçÔ∏è Sign Message';
            }
        });
        
        // Verify Signature
        btnVerify.addEventListener('click', async () => {
            const message = document.getElementById('verify-message').value;
            const signature = document.getElementById('verify-signature').value;
            const address = document.getElementById('verify-address').value;
            const resultDiv = document.getElementById('verify-result');
            
            if (!message || !signature || !address) {
                resultDiv.textContent = 'Please fill in all fields';
                resultDiv.className = 'result error';
                resultDiv.classList.remove('hidden');
                return;
            }
            
            try {
                // Recover signer address from signature
                const recoveredAddress = ethers.verifyMessage(message, signature);
                const isValid = recoveredAddress.toLowerCase() === address.toLowerCase();
                
                if (isValid) {
                    resultDiv.innerHTML = `<strong>‚úÖ Signature is VALID!</strong>\n\n` +
                        `The message was signed by:\n${recoveredAddress}`;
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = `<strong>‚ùå Signature is INVALID!</strong>\n\n` +
                        `Expected: ${address}\n` +
                        `Recovered: ${recoveredAddress}`;
                    resultDiv.className = 'result error';
                }
                
                resultDiv.classList.remove('hidden');
                
            } catch (error) {
                resultDiv.textContent = 'Verification Error: ' + error.message;
                resultDiv.className = 'result error';
                resultDiv.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
